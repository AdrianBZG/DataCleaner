<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<job xmlns="http://eobjects.org/analyzerbeans/job/1.0">
	<job-metadata>
		<job-description>EasyDQ transaction log processor</job-description>
	</job-metadata>
	<source>
		<data-context ref="logfile" />
		<columns>
			<column path="username" id="col_username" />
			<column path="partner" id="col_partner" />
			<column path="functionname" id="col_functionname" />
			<column path="endpoint" id="col_endpoint" />
			<column path="status" id="col_status" />
			<column path="ip" id="col_ip" />
			<column path="timestamp" id="col_timestamp" />
			<column path="records" id="col_records" />
			<column path="clientid" id="col_clientid" />
		</columns>
	</source>
	<transformation>
		<filter name="Check status=200">
			<descriptor ref="Equals" />
			<properties>
				<property name="Values" value="[200]" />
			</properties>
			<input ref="col_status" />
			<outcome category="VALID" id="status_valid" />
			<outcome category="INVALID" id="status_invalid" />
		</filter>

		<transformer name="partner_id lookup" requires="status_valid">
			<!-- TODO: Missing implementation of "Datastore lookup" transformer -->
			<descriptor ref="Datastore lookup" />
			<properties>
				<property name="Datastore" value="portal" />
				<property name="Table" value="hf_partner" />
				<property name="Condition columns" value="[PartnerURL]" />
				<property name="Output columns" value="[PartnerID]" />
			</properties>
			<input ref="col_partner" />
			<output id="col_partner_id" name="partner_id" />
		</transformer>

		<transformer name="user_id and customer_id lookup"
			requires="status_valid">
			<descriptor ref="Datastore lookup" />
			<properties>
				<property name="Datastore" value="portal" />
				<property name="Table" value="hf_user" />
				<property name="Condition columns" value="[User,PartnerID]" />
				<property name="Output columns" value="[UserID,CustomerID]" />
			</properties>
			<input ref="col_username" />
			<input ref="col_partner_id" />
			<output id="col_user_id" name="user_id" />
			<output id="col_customer_id" name="customer_id" />
		</transformer>

		<transformer name="service_function_id and usage_credits lookup"
			requires="status_valid">
			<descriptor ref="Datastore lookup" />
			<properties>
				<property name="Datastore" value="portal" />
				<property name="Table" value="hf_service_function" />
				<property name="Condition columns" value="[Function]" />
				<property name="Output columns" value="[ServiceFunctionID,UsageCredits]" />
			</properties>
			<input ref="col_functionname" />
			<output id="col_service_function_id" name="service_function_id" />
			<output id="col_usage_credits" name="usage_credits" />
		</transformer>

		<transformer name="ip2long" requires="status_valid">
			<!-- TODO: Missing implementation of "Convert IP address to number" transformer -->
			<descriptor ref="Convert IP address to number" />
			<input ref="col_ip" />
			<output id="col_ip_long" name="IP address (as long)" />
		</transformer>

	</transformation>
	<analysis>
		<analyzer name="Write to transaction table" requires="status_valid">
			<!-- TODO: This implementation is not done yet -->
			<descriptor ref="To datastore" />
			<properties>
				<property name="Datastore" value="portal" />
				<property name="Table name" value="hf_transaction" />
				<property name="Target columns"
					value="[PartnerID,CustomerID,UserID,ServiceFunctionID,UsageCredits,Records,IP,TimestampTransaction]" />
			</properties>
			<input ref="col_partner_id" />
			<input ref="col_customer_id" />
			<input ref="col_user_id" />
			<input ref="col_service_function_id" />
			<input ref="col_usage_credits" />
			<input ref="col_records" />
			<input ref="col_ip_long" />
			<input ref="col_timestamp" />
			
			<!-- TODO: Include client id? -->
			<!-- TODO: Include date parts? -->
		</analyzer>
	</analysis>
</job>
